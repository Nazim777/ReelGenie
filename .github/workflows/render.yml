name: Video Production Pipeline

on:
  workflow_dispatch:
    inputs:
      audioURL:
        description: "URL of the audio file"
        required: true
      captionJsonUrl:
        description: "URL of the uploaded captions JSON file"
        required: true
      imageJson:
        description: "JSON array of image URLs"
        required: true
      caption_Style:
        description: "Caption style string"
        required: true
      videoId:
        description: "ID of the video record in Neon"
        required: true
      durationInFrames:
        description: "Total duration of video in frames"
        required: true

jobs:
  render-and-upload:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - run: npm ci --legacy-peer-deps

      - name: Install jq
        run: sudo apt-get install -y jq

      # ‚úÖ Prepare Remotion props from inputs
      - name: Prepare Input Data
        run: |
          echo "üì• Downloading captions JSON from: ${{ github.event.inputs.captionJsonUrl }}"
          curl -L "${{ github.event.inputs.captionJsonUrl }}" -o caption.json

          echo '${{ github.event.inputs.imageJson }}' | jq . > image.json
          echo "${{ github.event.inputs.caption_Style }}" > style.txt

          DURATION_FRAMES=${{ github.event.inputs.durationInFrames }}
          echo "üéû Duration in frames: $DURATION_FRAMES"

          jq -n \
            --arg audioFileUrl "${{ github.event.inputs.audioURL }}" \
            --slurpfile captions caption.json \
            --slurpfile imageList image.json \
            --argjson durationInFrames $DURATION_FRAMES \
            '{
              script: [],
              audioFileUrl: $audioFileUrl,
              captions: $captions[0],
              imageList: $imageList[0],
              setDurationInFrame: null,
              durationInFrames: $durationInFrames
            }' > input-props.json

          echo "‚úÖ Created input-props.json"
          cat input-props.json

      # ‚úÖ Dynamically create the entry file with the correct duration
      - name: Create dynamic Remotion entry
        run: |
          TMP_ENTRY=src/tmp-entry.tsx
          mkdir -p src
          echo "import { registerRoot } from 'remotion';
          import React from 'react';
          import { Composition } from 'remotion';
          import RemotionVideo from './app/dashboard/_components/RemotionVideo';

          const defaultProps = {
            script: [],
            imageList: [],
            audioFileUrl: '',
            captions: [],
            setDurationInFrame: () => {},
          };

          export const RemotionRoot = () => (
            <>
              <Composition
                id='RemotionVideo'
                component={RemotionVideo}
                durationInFrames={${{ github.event.inputs.durationInFrames }}}
                fps={30}
                width={1280}
                height={720}
                defaultProps={defaultProps}
              />
            </>
          );

          registerRoot(RemotionRoot);" > $TMP_ENTRY

          echo "‚úÖ Created dynamic entry file at $TMP_ENTRY"

      # ‚úÖ Render the video using the dynamic entry
      - name: Render Video
        run: npx remotion render src/tmp-entry.tsx RemotionVideo out/video.mp4 --props=./input-props.json

      - name: Verify Render Output
        run: |
          if [ ! -f out/video.mp4 ]; then
            echo "‚ùå Render failed: No output file found"
            exit 1
          fi
          echo "‚úÖ Render successful - File size: $(du -h out/video.mp4 | cut -f1)"

      # ‚úÖ Upload the rendered video to Cloudinary
      - name: Upload to Cloudinary
        env:
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          npm install cloudinary --legacy-peer-deps
          node -e "
            const cloudinary = require('cloudinary').v2;
            const fs = require('fs');
            cloudinary.config({
              cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
              api_key: process.env.CLOUDINARY_API_KEY,
              api_secret: process.env.CLOUDINARY_API_SECRET
            });
            cloudinary.uploader.upload('out/video.mp4', {
              resource_type: 'video',
              folder: 'renders',
              overwrite: true
            }, (error, result) => {
              if (error) {
                console.error('‚ùå Cloudinary upload failed:', error);
                process.exit(1);
              }
              console.log('‚úÖ Cloudinary upload successful:', result.secure_url);
              fs.writeFileSync('cloudinary-response.json', JSON.stringify(result));
            });
          "

      # ‚úÖ Notify frontend after successful upload
      - name: Notify Frontend
        run: |
          VIDEO_URL=$(jq -r .secure_url cloudinary-response.json)
          echo "üé¨ Sending video to frontend: $VIDEO_URL"
          curl -X POST "https://reel-genie-nine.vercel.app/api/webhook" \
            -H "Content-Type: application/json" \
            -d "{\"video_url\": \"$VIDEO_URL\", \"videoId\": \"${{ github.event.inputs.videoId }}\"}"
